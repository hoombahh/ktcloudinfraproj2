pipeline {
  agent any

  environment {
    // 1. RDS ì ‘ì† ì •ë³´ (ë°›ì•„ì˜¨ ì •ë³´)
    RDS_HOST = "curry-db.cnq2ue4q4862.ap-northeast-2.rds.amazonaws.com"
    RDS_PORT = "3306"
    RDS_USER = "admin"
    RDS_PW   = credentials('rds-admin-pw') // ì•„ê¹Œ ë“±ë¡í•œ ID

    // 2. Replication ê³„ì • (OpenStack Masterì— ì ‘ì†í•  ê³„ì •)
    REPL_USER = "repl"
    REPL_PW   = credentials('mariadb-repl-pw') // ê¸°ì¡´ì— ë“±ë¡í•´ë‘” ê²ƒ

    DB_NAME   = "immigration"
    OS_CLOUD  = "openstack"
    SSH_KEY_ID = 'ssh_key_openstack'
  }

  stages {
    stage('1. Git Checkout') {
        steps {
            git branch: 'main', url: 'https://github.com/hoombahh/ktcloudinfraproj2.git'
        }
    }

    stage('2. Get Master IP & Fetch Dump') {
      steps {
        script {
           // 2-1. Terraformì—ì„œ Master IP ê°€ì ¸ì˜¤ê¸°
           dir('openstack') {
             env.MASTER_IP = sh(returnStdout: true, script: "terraform output -raw master_ip").trim()
           }
           echo " OpenStack Master IP: ${env.MASTER_IP}"

           // 2-2. Masterì—ì„œ ìµœì‹  ë¤í”„ íŒŒì¼ ê°€ì ¸ì˜¤ê¸° (SCP)
           sshagent(credentials: [SSH_KEY_ID]) {
               sh "scp -o StrictHostKeyChecking=no ubuntu@${MASTER_IP}:/tmp/dump.sql ./dump.sql"
           }
        }
      }
    }

    stage('3. Extract Binlog Info') {
      steps {
        script {
          // ë¤í”„ íŒŒì¼ì—ì„œ ë¡œê·¸ ìœ„ì¹˜(ì¢Œí‘œ) ì¶”ì¶œ
          env.MASTER_LOG_FILE = sh(
            script: "grep 'MASTER_LOG_FILE' dump.sql | sed -n \"s/.*MASTER_LOG_FILE='\\([^']*\\)'.*/\\1/p\"",
            returnStdout: true
          ).trim()

          env.MASTER_LOG_POS = sh(
            script: "grep 'MASTER_LOG_POS' dump.sql | sed -n \"s/.*MASTER_LOG_POS=\\([0-9]*\\).*/\\1/p\"",
            returnStdout: true
          ).trim()
        }
        echo "ğŸ“ Binlog File: ${MASTER_LOG_FILE}"
        echo "ğŸ“ Binlog Pos : ${MASTER_LOG_POS}"
      }
    }

    stage('4. Restore Dump to RDS (Slave)') {
      steps {
        echo "ğŸ“¡ RDS(${RDS_HOST})ë¡œ ë°ì´í„° ë¶€ì–´ë„£ëŠ” ì¤‘..."
        // mysql í´ë¼ì´ì–¸íŠ¸ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨ (ì—†ìœ¼ë©´ ì„¤ì¹˜: apt install mariadb-client -y)
        sh """
        mysql -h ${RDS_HOST} -P ${RDS_PORT} \
          -u${RDS_USER} -p${RDS_PW} < dump.sql
        """
      }
    }

    stage('5. Configure RDS Replication') {
      steps {
        echo " Replication ì—°ê²° ì„¤ì • ì¤‘..."
        sh """
        mysql -h ${RDS_HOST} -P ${RDS_PORT} \
          -u${RDS_USER} -p${RDS_PW} << SQL || true

        -- ê¸°ì¡´ ì„¤ì • ì´ˆê¸°í™” (ì—ëŸ¬ ë¬´ì‹œ)
        STOP SLAVE;
        RESET SLAVE;

        -- Master ì •ë³´ ì…ë ¥
        CHANGE MASTER TO
          MASTER_HOST='${MASTER_IP}',
          MASTER_USER='${REPL_USER}',
          MASTER_PASSWORD='${REPL_PW}',
          MASTER_LOG_FILE='${MASTER_LOG_FILE}',
          MASTER_LOG_POS=${MASTER_LOG_POS};

        -- ë³µì œ ì‹œì‘
        START SLAVE;
        SQL
        """
      }
    }

    stage('6. Check Slave Status') {
      steps {
        echo " ìƒíƒœ í™•ì¸"
        sh """
        mysql -h ${RDS_HOST} -P ${RDS_PORT} \
          -u${RDS_USER} -p${RDS_PW} -e "SHOW SLAVE STATUS\\G"
        """
      }
    }
  }
}
