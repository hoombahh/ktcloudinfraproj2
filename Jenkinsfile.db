pipeline {
  agent any

  parameters {
    string(name: 'UPSTREAM_JOB_NAME', 
           defaultValue: 'dbrep', 
           description: 'OpenStack Master')
  }

  environment {
    // 1. RDS ì ‘ì† ì •ë³´ (ë°›ì•„ì˜¨ ì •ë³´)
    RDS_HOST = "curry-db.cnq2ue4q4862.ap-northeast-2.rds.amazonaws.com"
    RDS_PORT = "3306"
    RDS_USER = "admin"
    RDS_PW   = credentials('rds-admin-pw') // ì•„ê¹Œ ë“±ë¡í•œ ID

    // 2. Replication ê³„ì • (OpenStack Masterì— ì ‘ì†í•  ê³„ì •)
    REPL_USER = "repl"
    REPL_PW   = credentials('mariadb-repl-pw')

    DB_NAME   = "immigration"
    OS_CLOUD  = "openstack"
    SSH_KEY_ID = 'ssh_key_openstack'
  }

  stages {
    stage('1. Get master ip') {
        steps {
        script {
           try {
               copyArtifacts(projectName: "${params.UPSTREAM_JOB_NAME}", 
                             filter: 'master_ip.txt', 
                             selector: [$class: 'StatusBuildSelector', stable: false])
               
               env.MASTER_IP = readFile('master_ip.txt').trim()
               echo " ìë™ìœ¼ë¡œ ì°¾ì€ Master IP: ${env.MASTER_IP}"
           } catch (Exception e) {
               error " IP íŒŒì¼ì„ ëª» ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. ì‘ì—… ì´ë¦„('${params.UPSTREAM_JOB_NAME}')ì´ ì •í™•í•œì§€, í•´ë‹¹ ì‘ì—…ì´ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸"
           }
        }
      }
    }

    stage('2. Fetch Dump') {
      steps {
        script {
           echo " OpenStack Master(${env.MASTER_IP}) ì ‘ì† ë° ë¤í”„ ê°€ì ¸ì˜¤ê¸°..."
           
           sshagent(credentials: [SSH_KEY_ID]) {
               sh "rm -f dump.sql"
               // IPê°€ ìë™ì´ë‹ˆ ë°”ë¡œ SCP ê°€ëŠ¥
               sh "scp -o StrictHostKeyChecking=no ubuntu@${MASTER_IP}:/tmp/dump.sql ./dump.sql"
           }
           sh "ls -lh dump.sql"
        }
      }
    }

    stage('3. Extract Binlog Info') {
      steps {
        script {
          // ë¤í”„ íŒŒì¼ì—ì„œ ë¡œê·¸ ìœ„ì¹˜(ì¢Œí‘œ) ì¶”ì¶œ
          env.MASTER_LOG_FILE = sh(
            script: "grep 'MASTER_LOG_FILE' dump.sql | sed -n \"s/.*MASTER_LOG_FILE='\\([^']*\\)'.*/\\1/p\"",
            returnStdout: true
          ).trim()

          env.MASTER_LOG_POS = sh(
            script: "grep 'MASTER_LOG_POS' dump.sql | sed -n \"s/.*MASTER_LOG_POS=\\([0-9]*\\).*/\\1/p\"",
            returnStdout: true
          ).trim()
        }
        echo "ğŸ“ Binlog File: ${MASTER_LOG_FILE}"
        echo "ğŸ“ Binlog Pos : ${MASTER_LOG_POS}"
      }
    }
    
    stage('4. Restore Dump to RDS (Slave)') {
      steps {
        echo " RDS(${RDS_HOST})ë¡œ ë°ì´í„° ë¶€ì–´ë„£ëŠ” ì¤‘..."
        //  export MYSQL_PWD=\$RDS_PW ì‚¬ìš©
        sh """
        export MYSQL_PWD=\$RDS_PW
        
        mysql -h ${RDS_HOST} -P ${RDS_PORT} -u ${RDS_USER} < dump.sql
        """
      }
    }

    stage('5. Configure RDS Replication') {
      steps {
        echo " Replication ì—°ê²° ì„¤ì • ì¤‘..."
        sh """
        export MYSQL_PWD=\$RDS_PW
        
        mysql -h ${RDS_HOST} -P ${RDS_PORT} -u ${RDS_USER} << SQL || true
        
        STOP SLAVE;
        RESET SLAVE;

        CHANGE MASTER TO
          MASTER_HOST='${MASTER_IP}',
          MASTER_USER='${REPL_USER}',
          MASTER_PASSWORD='${REPL_PW}',
          MASTER_LOG_FILE='${MASTER_LOG_FILE}',
          MASTER_LOG_POS=${MASTER_LOG_POS};

        START SLAVE;
        SQL
        """
      }
    }
    
    stage('6. Check Slave Status') {
      steps {
        echo " ìƒíƒœ í™•ì¸"
        sh """
        export MYSQL_PWD=\$RDS_PW
        
        mysql -h ${RDS_HOST} -P ${RDS_PORT} -u ${RDS_USER} -e "SHOW SLAVE STATUS\\G"
        """
      }
    }
  }
}
