pipeline {
    agent any

    environment {
        OS_AUTH_URL             = "http://10.242.0.50:5000/v3"
        OS_PROJECT_ID           = "aca5aa59b7264b2db407f58afac8667e"
        OS_PROJECT_NAME         = "curry"
        OS_USER_DOMAIN_NAME     = "Default"
        OS_PROJECT_DOMAIN_ID    = "default"
        OS_REGION_NAME          = "ap-northeast-2"
        OS_INTERFACE            = "public"
        OS_IDENTITY_API_VERSION = "3"
        TF_IN_AUTOMATION        = "true"
    }

    stages {
        stage('1. Git Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/hoombahh/ktcloudinfraproj2.git'
            }
        }

        stage('2. 인증 파일 준비') {
            steps {
                sh 'cp /var/lib/jenkins/clouds.yaml ./openstack/'
            }
        }

        stage('3. Terraform Init') {
            steps {
                dir('openstack') {
                    sh 'terraform init'
                }
            }
        }

        stage('4. Terraform Plan') {
            steps {
                dir('openstack') {
                    // 변경 사항을 미리 보여줍니다
                    sh 'terraform plan'
                }
            }
        }

        // 요청하신 승인 단계 (여기서 멈춥니다!)
        stage('5. Terraform Approval') {
            steps {
                input message: '오픈스택 VM 2대를 생성하시겠습니까?', ok: '진행시켜!'
            }
        }

        stage('6. Terraform Apply') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'os_auth_creds', passwordVariable: 'OS_PASSWORD', usernameVariable: 'OS_USERNAME')]) {
                    dir('openstack') {
                        // 진짜 생성
                        sh 'export OS_PASSWORD=$OS_PASSWORD && terraform apply -auto-approve'
                        
                        // (중요) 나중을 위해 만들어진 IP를 파일로 저장해둡니다.
                        sh 'terraform output -raw master_ip > ../master_ip.txt'
                    }
                }
            }
        }

        // --- 여기부터는 "진행시켜!"를 눌렀을 때만 실행됩니다 ---
        
        stage('7. 접속 대기 (Wait for SSH)') {
            steps {
                script {
                    echo "VM 생성이 완료되었습니다. 30초 대기 후 K8s 설치를 시도합니다..."
                    sleep 30
                }
            }
        }

        stage('8. 쿠버네티스 설치 (Install K8s)') {
            steps {
                script {
                    try {
                        def MASTER_IP = readFile('master_ip.txt').trim()
                        sshagent(credentials: ['ssh_key_openstack']) {
                            // 설치 스크립트 전송 및 실행
                            sh "scp -o StrictHostKeyChecking=no scripts/install_k8s.sh ubuntu@${MASTER_IP}:/home/ubuntu/"
                            sh "ssh -o StrictHostKeyChecking=no ubuntu@${MASTER_IP} 'bash /home/ubuntu/install_k8s.sh'"
                        }
                    } catch (Exception e) {
                        echo "⚠️ K8s 설치 단계에서 에러가 났거나, IP 파일이 없습니다. (Apply를 안 했으면 정상입니다)"
                    }
                }
            }
        }
    }
}
